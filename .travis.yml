sudo: true
language: python

python:
  - 3.5
  - 3.6

services:
  - postgresql

addons:
  apt:
    packages:
    - ldap-utils
    - slapd

install:
  - pip install -r requirements.pip

before_script:
  - cp django_ldap_user_registration/local_settings.py.default django_ldap_user_registration/local_settings.py
  - export DJ_DEBUG=False
  - export DATABASE_URL=postgres://postgres@localhost/travisdb
  - psql -c "CREATE DATABASE travisdb;" -U postgres
  - python manage.py migrate
  - sudo apt-get purge slapd
  - export DEBIAN_FRONTEND=noninteractive
  - cat test_data/ldap/debconf-slapd.conf | sudo debconf-set-selections
  - sudo apt-get install ldap-utils slapd
  - sudo ldapadd -x -D cn=admin,dc=zion,dc=ac,dc=ke -w admin -f test_data/ldap/add_content.ldif

deploy:
  provider: pypi
  user: sureronald
  password:
    secure: "H6r5iNc/4KqqGy4ZfbQTO+NVeBfbJek9bZZQsOgwL7hMITSzRqiPVjADZUCNh/UYSaiLFFxrsILNsVsR/mQXa7TS8BvXKNURnoURUx1P2apT2JcDWenKUJNF1iNF0+bkrdi+P/Tyu5iD8PRhKlTnSnTta1u2VbzaWkMaZrdPGn4fb5z5W798E0Z6B/Ymxh45HoK0K6Ak9CNgUd8HyXTnnO13TDjO2r/+Nlm/BhSnoxI0OGXFjpZKxzotx8rFmDmAIof4LS2tmZX3y8FxnbTdkFE39HemfLf9WH9Y/IiQPExzenKfpuVqqHG29honS2DXjZBQIl/yWEVRRmtgdyS+hEBtKfpPL0mjEp/7Q44E08x+VscQW20vktwI8wv8guAR5KDjkRdMFs9WeBHyIhDew8Da4Egu18E3A/DV2m2Liio22TrR2Y34Ekr8uffxpK9VL1UJxQIyshlR+D94L9uSrf2sIqo3s923jfPEk1IpiVT7FbF7c2qxV7QOJsBTOpqesyhR3G6YLsTLA7rmidGUqnOJqZ+Z4zmo+Tp7RDFHU+euCzbhWdARxnyroiVo42oBTKJPK1zwhT4mXxWLWUZjdZ4k14/hExM4byimUt4PEYqeZSl3868mu+ad/BMTyB+Ye47TnPxdq+UWSAiP9C2xzD2hfXaU+Eqsh8XmMqUPovA="
  on:
    tags: true

script:
 - coverage run --source=user -m pytest

after_success:
  - coveralls
