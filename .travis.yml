sudo: true
language: python

python:
  - 3.6.5

services:
  - postgresql

addons:
  apt:
    packages:
    - ldap-utils
    - slapd

install:
  - pip install -r requirements.pip

before_script:
  - cp django_ldap_user_registration/local_settings.py.default django_ldap_user_registration/local_settings.py
  - export DJ_DEBUG=False
  - export DATABASE_URL=postgres://postgres@localhost/travisdb
  - psql -c "CREATE DATABASE travisdb;" -U postgres
  - python manage.py migrate
  - sudo apt-get purge slapd
  - export DEBIAN_FRONTEND=noninteractive
  - cat test_data/ldap/debconf-slapd.conf | sudo debconf-set-selections
  - sudo apt-get install ldap-utils slapd
  - sudo ldapadd -x -D cn=admin,dc=zion,dc=ac,dc=ke -w admin -f test_data/ldap/add_content.ldif

deploy:
  provider: pypi
  user: sureronald
  password:
    secure: "VOzLncdFEYtSU/yWTTYJl3rSvubGyhKdR9oX79pvomg+OVYSy1MQ10idTlvKRun/yn1KhrB+RZbNau4QxLkBrhEBoe1BB+1iOQtr9PCuyF850JfNfYf9vyKqiei6UrFTyLRSYcV8IgGUZExW+lKAJot1i7jIZpu3mshXym8SG93+IEnzreSjq788AE24rhAXgyTPn+uqL+roP7muo/bomPkq9QY0qLTHTTHJTmddTCA8vU2XfbO3/nzpnPr9//3UQr/7ttedZjfql+O9mlr2n1x/FDQ6pRtBbYl1D23hxOCbqpyY72Hiwwr0sZYifs1xdggj57+c59ZqSa+vlSDYQ/7QTJF7hzcUJobM5Nplp7XBRvuvkib3IIamN29mq6PA4xRD/1zqrgwsEpUtCBVPPh2hGa8h/f5FqdpIvyX3mQVJyGHxmU1rxtd5er4xIiUG4PakGoYlQt9s8MbvbT1U9ewvL/KZtm6bm0SE+uvFP9b/vFxC4NPhJkhlSXWidCPBiGCV6s0qcvD0Ocw5ZaDezxwSd49oAtXMrTB+jvDwRTyWTFz3LQEJUEoGLchfBvkGKFyKLo8rcck5rinI/Dgx3a5GNluKEkwsn550Sj68Czso13FKGqIU6fDTbYDr2S+JQ0YbaW5Mu2Hm+aB9DBEZxBQ1duOmm+NuqNdB44c8ewc="
#  on:
#    tags: true
  server: https://test.pypi.org/legacy/

script:
 - coverage run --source=user -m pytest

after_success:
  - coveralls
