sudo: true
language: python

python:
  - 3.6.5

services:
  - postgresql

addons:
  apt:
    packages:
    - ldap-utils
    - slapd

install:
  - pip install -r requirements.pip

before_script:
  - cp django_ldap_user_registration/local_settings.py.default django_ldap_user_registration/local_settings.py
  - export DJ_DEBUG=False
  - export DATABASE_URL=postgres://postgres@localhost/travisdb
  - psql -c "CREATE DATABASE travisdb;" -U postgres
  - python manage.py migrate
  - sudo apt-get purge slapd
  - export DEBIAN_FRONTEND=noninteractive
  - cat test_data/ldap/debconf-slapd.conf | sudo debconf-set-selections
  - sudo apt-get install ldap-utils slapd
  - sudo ldapadd -x -D cn=admin,dc=zion,dc=ac,dc=ke -w admin -f test_data/ldap/add_content.ldif

deploy:
  provider: pypi
  user: sureronald
  password:
    secure: "nC6lgzdnG8N01LzXjIfk3KMgyEd4jyWPHJGan8T9s9zi3tGAzoeZ7UWIjh6YHmRgUOy4FnZQ6MpV2TsbChFUhgQefUY9qk0+1kY2OK+Cgu3Igy0TtAuJV9qeANZX8iia8wO+S2XPSJ/wNpEZAjh95TZyTSN8xmr8GtmzKOmBZa6U2P4Zs5rEWoyPQXgE7qGyOg/VHL0hPHbKSvW+DhUrODK9W/l8CeDYlHxSyGE0NtN8iL95MdYbIkK+0sp5Z3lETOSQ9QPxAPrG5Kvg4dagayaDvhGBOrFDEalCK3tgdD2dgvp43y6Jr4e0e4Y92jjFSMAaVaWsx2OYr0hw0flhCvtflshBSta5lHGcTsAYLnJMwUX254tioMAClzD2ToIvW+P2myIJ63ktcC0pboPSrovrLXX1YmKW+tQTa5GbzBxgEAD0rkoBpm0BXbWV3FPmPt6c0ZZ/Tl2H55zh3R3fgw8Ujgr0V6abEtVBgY3gkCOXn9ehqVjbbk9dfKyKwapESs6SKnv9Fq+5pEdLvh+HxpcZpDtfCBdT6QbjEEY8Kbj5ijwduemJhZ6ig7QLwrjVL1gpodj4r/PR3hrAgPaAmlxD997oOPsLtBrvEoT0LbFXI80V/Xddo/Yp6CZ2af7ZAMbxNBvfZdmCFI9dsnXyQ6JbInjrAF4WfLV23PerTOU="
#  on:
#    tags: true
  server: https://test.pypi.org/legacy/

script:
 - coverage run --source=user -m pytest

after_success:
  - coveralls
