sudo: true
language: python

python:
  - 3.6.5

services:
  - postgresql

addons:
  apt:
    packages:
    - ldap-utils
    - slapd

install:
  - pip install -r requirements.pip

before_script:
  - cp django_ldap_user_registration/local_settings.py.default django_ldap_user_registration/local_settings.py
  - export DJ_DEBUG=False
  - export DATABASE_URL=postgres://postgres@localhost/travisdb
  - psql -c "CREATE DATABASE travisdb;" -U postgres
  - python manage.py migrate
  - sudo apt-get purge slapd
  - export DEBIAN_FRONTEND=noninteractive
  - cat test_data/ldap/debconf-slapd.conf | sudo debconf-set-selections
  - sudo apt-get install ldap-utils slapd
  - sudo ldapadd -x -D cn=admin,dc=zion,dc=ac,dc=ke -w admin -f test_data/ldap/add_content.ldif

deploy:
  provider: pypi
  user: sureronald
  password:
    secure: "AAsHrrIND/P2JO7N+M5ZbelPgYZ102/pWoOyey6kd+IabMePblUq6M28WZswEWwjoOVrODRi6tsGEnZQ0CJuN1NfRrGRLjXGoJkblALdLEiiRTXEZujhiYJFolcr+3zCi2EK67RkzvIfpsZ+blE1e+HwEF+Cc6rXS5H6IKxdFk+jPulBbh/anRpiKhctbjWgUnEDZPmFZcEfgcKpo6V1Ik58+kbUYQhCqMGR8ZCvk1jYSyiOylqyWpjLuPN/j3WLfidyVSldPdN5FBY93Gc++Tbw9REq/ZnnOP06+TzkXDe2X64sXPOjqmJMWkSZSNckEyiYs+KQgVbqlvs1bVUD8crY5hvLiUpAacOuNmQNN+4K4108I+xGajtdDiCF87lPK0U2SdqPpkVbJRoR4VKVQ495Oesw5eIkfVPT5ySu6j3rT9bziAqewnW/TIdYHr+L1Mk5a5bVPzt3FThxc6Nhnj5vJU1BgTShU/UFemeu1/+WtJHw9zHmlt31A4qRxSj9XeKaqT2GuIRELhDwwbGUbpOGgs/6TAm+X/Qe2aoM6tVzH3IZ1jhtwTTStXl0g6QTH16fD8JZRE7a/EZGnBhrqhAUOByhtbLJduEFuwHTUrFM8MoRB03H9OXqc3pIr42qt28gBv4qFOE3gOWkJ0oEHhnu3Fq6yhcB8yKGupglJks="
#  on:
#    tags: true
  server: https://test.pypi.org/legacy/

script:
 - coverage run --source=user -m pytest

after_success:
  - coveralls
